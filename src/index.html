<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Jassdel.com</title>
  <base href="/">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  


  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"> 
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Bebas+Neue&display=swap" rel="stylesheet">
  <script src="https://rawgit.com/jackmoore/autosize/master/dist/autosize.min.js"></script>
  <script type="text/javascript" 
        src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script type="text/javascript" 
        src="https://openpay.s3.amazonaws.com/openpay.v1.min.js"></script>
<script type='text/javascript' src="https://openpay.s3.amazonaws.com/openpay-data.v1.min.js"></script>


<script >
		
    var deviceSessionId = OpenPay.deviceData.setup("formId", "deviceIdHiddenFieldName");
            OpenPay.setId('myllylbt6vwlywximkxg');
            OpenPay.setApiKey('pk_c5b567e442c344f4b0e34e21262cb90a');
            OpenPay.setSandboxMode(true);
            
            $("#muestra_error_general").hide();
            $("#mostrar_conf_pedido_2").hide();
            $("#div_msj_aviso_2").hide();
            $("#btn_cerrer_form_pago").hide();
		function fn_pagar()
		{
			//ocultamos todos los msj de errores para que solo se muestre los reales.
			$("#error_nombre_tarjeta").hide();
			$("#error_txt_num_tarjeta").hide();
			$("#error_cvv").hide();
			$("#error_fecha_exp").hide();
			
      $("#muestra_error_general").hide();
      
   
     

      $("#mostrar_conf_pedido_2").hide();      
      $("#div_msj_aviso_2").hide();
      $("#btn_cerrer_form_pago").hide();
      
			//si la funcion de validacion regresa 1, es que funciono todo correctamente.
			if(fn_valida_formulario()==1)
			{
          $("#div_cargando").show();
          
          //si el token se ejecuta correctamente ejecutamos la funcion: sucess_callbak
          //si el token no se genera correctamente ejecutamos la funcion: error_callbak
          OpenPay.token.extractFormAndCreate('payment-form', sucess_callbak, error_callbak); 
          
                
      }
      
		}
		function sucess_callbak(response)
		{ 
      
			var content = '';
			content += 'Id tarjeta: ' + response.data.id+ '<br />';
			content += 'A nombre de: ' + response.data.holder_name + '<br />';
			content += 'Marca de tarjeta usada: ' + response.data.brand + '<br />';
			
			guarda_venta(response);
			
    }
    
    function guarda_venta(response)
    {
        var params = {
            'session':localStorage.getItem("session"), //aqui defines el valor del parametro
            'token_id': response.data.id,
            'amount':localStorage.getItem("total_pagar"),
            'description':"Compra Sitio Web",
            'deviceIdHiddenFieldName':deviceSessionId,            
            'tipo_compra':"2"
        };

        var request = $.ajax({
            
            url: localStorage.getItem("local_url")+"ventas/guarda_venta/",
            data:params,
            method: "POST"
        });

        request.done(function( data ) {
          //si es cero es porque marco error
          if (data[0].estatus=="0")
          {
            $("#muestra_error_general").show();
			      $("#msj_error_general_pago").text(data[0].msj);
           

            $("#div_cargando").hide();
          }
          else
          {
            $("#div_cargando").hide();
            $("#mostrar_conf_pedido_2").show();
            
            $("#div_msj_aviso_2").show();
            $("#folio_compra_2").text(data[0].folio);

            $(".cls_muestra_tiket").show();
          }



        });

          
        request.fail(function( error ) {
            console.log( 'Error: ' , error );
            $("#div_cargando").hide();
        });
    }
    function fn_oculta_form_pagar()
    {      
      
      $("#mostrar_conf_pedido_2").hide();      
      $("#div_msj_aviso_2").hide();
      $("#btn_cerrar_form_pago").hide();
      
    }
		function error_callbak(response)
		{
      console.log("error");
			//abano se muestra como se lee el error 
			 var content = '';
			content += 'Estatus del error: ' + response.data.status + '<br />';
			content += 'Error: ' + response.message + '<br />';
			content += 'Descripción: ' + response.data.description + '<br />';
			content += 'ID de la petición: ' + response.data.request_id + '<br />';
			$("#muestra_error_general").show();
			$("#msj_error_general_pago").text(content);
      $("#div_cargando").hide();
		}
		
		function fn_valida_formulario()
		{
			
		
			if($("#holder_name").val()=="")
			{
				$("#error_nombre_tarjeta").show();
				return 0;
			}
			
			
			//validamos que el tipo de tarjeta sea valido.
			if (!OpenPay.card.validateCardNumber($("#card_number").val()))
			{				
				$("#error_txt_num_tarjeta").show();
				$("#error_num_tarjeta").text("El número de tarjeta no es valido.");
				return 0;
			}
			
			//validamos que el codigo CVV corresponda con la tarjeta.
			if (!OpenPay.card.validateCVC($("#cvv2").val(),$("#card_number").val()))
			{				
				$("#error_cvv").show();				
				return 0;
			}
			
			//validamos que el codigo CVV corresponda con la tarjeta.
			if (!OpenPay.card.validateExpiry($("#expiration-month").val(),$("#expiration-year").val()))
			{				
				$("#error_fecha_exp").show();
				$("#error_txt_fecha_exp").text("La fecha de expiracion es incorrecta");				
				return 0;
			}
			
			//validamos la longitud del año
			if ($("#expiration-year").val().length!=2)
			{
				$("#error_fecha_exp").show();				
				$("#error_txt_fecha_exp").text("El año debe ser de dos caracteres.");				
				return 0;
			}
			
			return 1;
			
		}
		
		
        $(document).ready(function() {
		
            autosize(document.getElementById("txt_desc_prod"));
            $("#div_cargando").hide();
            $("#div_error").hide();




			/* 
			var fn_valida_formulario=function()
			{
				if($("#nom_titular").val()=="")
				{
					$("#error_nombre_tarjeta").show();
					return 0;
				}
				return 1;
				
			}

            var sucess_callbak = function(response) {
              console.log(response);              
              console.log($("#deviceIdHiddenFieldName").val());
              guarda_venta(response);
             // console.log(response.data);
              var token_id = response.data.id;
              $('#token_id').val(token_id);

           //   $('#payment-form').submit();
             
            };

            var guarda_venta=function(response)
            {
              var params = {
                  'session':localStorage.getItem("session"), //aqui defines el valor del parametro
                  'token_id': response.data.id,
                  'amount':$("#amount").val(),
                  'description':$("#description").val(),
                  'deviceIdHiddenFieldName':$("#deviceIdHiddenFieldName").val()
              };

              var request = $.ajax({
                  url: "http://127.0.0.1:8000/ventas/guarda_venta/",//qa
                 //url: "http://pollo146.pythonanywhere.com/ventas/guarda_venta/",//produccion
                  data:params,
                  method: "POST"
              });

              request.done(function( data ) {
                //si es cero es porque marco error
                if (data[0].estatus=="0")
                {
                  $("#div_cargando").hide();
                  $("#div_error").show();
                  $("#error_tarjeta").text(data[0].msj);
                  $("#pay-button").prop("disabled", false);
                  setInterval(
                    ()=>
                    {
                      $("#div_error").hide();
                      clearInterval();
                    }
                  ,8000)
                }
                else
                {
                  $("#div_cargando").hide();
                  $("#folio_compra").text("Folio Compra "+data[0].folio);
                  $(".cls_muestra_tiket").show();
                }



              });

                
              request.fail(function( error ) {
                  console.log( 'Error: ' , error );
                  $("#div_cargando").hide();
              });
            }

            var error_callbak = function(response) {
              $("#div_cargando").hide();
                $("#div_error").show();
                
                
                var desc = response.data.description != undefined ? response.data.description : response.message;
                $("#error_tarjeta").text("ERROR [" + response.status + "] " + desc);
                $("#pay-button").prop("disabled", false);
                setInterval(
                  ()=>
                  {
                    $("#div_error").hide();
                    clearInterval();
                  }
                ,8000)
            };
		*/
        });
    </script>

</head>
<body>
  <app-root></app-root>

  <div  id="hover_error" style="width: 100%;height: 100%;position: fixed;top:0;left: 0;z-index: 100; background-color: black;opacity: 0.7;">

  </div>
  <div id="div_msj_error" *ngIf="mostrar_conf_pedido">
      <div style="width: 100%;text-align: center;">
        <br>

          <img src="../../assets/img/logo_peque.png" style="width:70px;margin:0 auto" >
      </div>
      <h1>
          Gracias por su visita.
          <br>
          <br>
              Esta pagina solo esta disponible en dispositivos moviles.
          <br>
          <br>
      </h1>
      <hr>
  </div>

</body>
</html>
