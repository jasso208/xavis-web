<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>XavisWeb</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"> 
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Bebas+Neue&display=swap" rel="stylesheet">

  <script type="text/javascript" 
        src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script type="text/javascript" 
        src="https://openpay.s3.amazonaws.com/openpay.v1.min.js"></script>
<script type='text/javascript' 
  src="https://openpay.s3.amazonaws.com/openpay-data.v1.min.js"></script>

<script type="text/javascript">
        $(document).ready(function() {

            $("#div_cargando").hide();
            $("#div_error").hide();
            OpenPay.setId('myllylbt6vwlywximkxg');
            OpenPay.setApiKey('pk_c5b567e442c344f4b0e34e21262cb90a');
            OpenPay.setSandboxMode(true);
            //Se genera el id de dispositivo
            var deviceSessionId = OpenPay.deviceData.setup("payment-form", "deviceIdHiddenFieldName");
            
            $('#pay-button').on('click', function(event) {
              $("#div_cargando").show();
                event.preventDefault();
                $("#pay-button").prop( "disabled", true);
                OpenPay.token.extractFormAndCreate('payment-form', sucess_callbak, error_callbak); 
            });

            var sucess_callbak = function(response) {
              console.log(response);              
              console.log($("#deviceIdHiddenFieldName").val());
              guarda_venta(response);
             // console.log(response.data);
              var token_id = response.data.id;
              $('#token_id').val(token_id);

           //   $('#payment-form').submit();
             
            };

            var guarda_venta=function(response)
            {
              var params = {
                  'session':localStorage.getItem("session"), //aqui defines el valor del parametro
                  'token_id': response.data.id,
                  'amount':$("#amount").val(),
                  'description':$("#description").val(),
                  'deviceIdHiddenFieldName':$("#deviceIdHiddenFieldName").val()
              };

              var request = $.ajax({
                  url: "http://127.0.0.1:8000/ventas/guarda_venta/",//qa
                 //url: "http://pollo146.pythonanywhere.com/ventas/guarda_venta/",//produccion
                  data:params,
                  method: "POST"
              });

              request.done(function( data ) {
                //si es cero es porque marco error
                if (data[0].estatus=="0")
                {
                  $("#div_cargando").hide();
                  $("#div_error").show();
                  $("#error_tarjeta").text(data[0].msj);
                  $("#pay-button").prop("disabled", false);
                  setInterval(
                    ()=>
                    {
                      $("#div_error").hide();
                      clearInterval();
                    }
                  ,8000)
                }
                else
                {
                  $("#div_cargando").hide();
                  $("#folio_compra").text("Folio Compra "+data[0].folio);
                  $(".cls_muestra_tiket").show();
                }



              });

                
              request.fail(function( error ) {
                  console.log( 'Error: ' , error );
                  $("#div_cargando").hide();
              });
            }

            var error_callbak = function(response) {
              $("#div_cargando").hide();
                $("#div_error").show();
                
                
                var desc = response.data.description != undefined ? response.data.description : response.message;
                $("#error_tarjeta").text("ERROR [" + response.status + "] " + desc);
                $("#pay-button").prop("disabled", false);
                setInterval(
                  ()=>
                  {
                    $("#div_error").hide();
                    clearInterval();
                  }
                ,8000)
            };

        });
    </script>

</head>
<body>
  <app-root></app-root>
</body>
</html>
